<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Import Weight from Google Takeout</title>
    <base target="_top" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <?!= HtmlService.createHtmlOutputFromFile('ui/dialogs/shared-theme').getContent() ?>
  </head>
  <body
    class="bg-[hsl(var(--background))] text-[hsl(var(--foreground))] m-0 fade-in"
    role="dialog"
    aria-labelledby="dialog-title"
    aria-describedby="dialog-description"
  >
    <main class="max-w-[580px] p-6 mx-auto">
      <article class="card p-6 scale-in">
        <header class="flex flex-col items-center mb-5">
          <div
            class="w-16 h-16 rounded-full bg-[hsl(var(--primary)/0.1)] flex items-center justify-center mb-4 p-3"
            aria-hidden="true"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
            >
              <path
                d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C2.62 6.22 2 7.5 2 9v9c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.5-.62-2.78-1.46-3.77zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"
                fill="currentColor"
                class="text-[hsl(var(--primary))]"
              />
            </svg>
          </div>
          <h1 id="dialog-title" class="heading-3 m-0 mb-2 text-center">
            Import Weight from Takeout
          </h1>
          <p
            id="dialog-description"
            class="text-sm text-[hsl(var(--muted-foreground))] text-center"
          >
            Import your weight history from Google Fit
          </p>
        </header>

        <section class="card mb-5 bg-[hsl(var(--muted))]">
          <div class="card-content">
            <div class="flex items-center gap-2 mb-3">
              <i
                data-lucide="info"
                class="icon icon-sm text-[hsl(var(--primary))] flex-shrink-0"
                aria-hidden="true"
              ></i>
              <h2 class="heading-4 m-0 text-[hsl(var(--foreground))]">
                Instructions
              </h2>
            </div>
            <ol
              class="space-y-2.5 pl-2 text-sm"
              aria-label="Step-by-step instructions"
            >
              <li class="flex items-start gap-2">
                <span class="badge badge-primary flex-shrink-0 mt-0.5">1</span>
                <span>
                  Go to
                  <a
                    href="https://takeout.google.com"
                    target="_blank"
                    class="text-[hsl(var(--primary))] hover:underline font-medium inline-flex items-center gap-1"
                  >
                    <i data-lucide="external-link" class="icon icon-sm"></i>
                    Google Takeout
                  </a>
                </span>
              </li>
              <li class="flex items-start gap-2">
                <span class="badge badge-primary flex-shrink-0 mt-0.5">2</span>
                <span>
                  Click <strong>Deselect all</strong> → select only
                  <strong>Google Fit</strong>
                </span>
              </li>
              <li class="flex items-start gap-2">
                <span class="badge badge-primary flex-shrink-0 mt-0.5">3</span>
                <span>
                  Under "All Fit data", click <strong>Deselect all</strong> →
                  select
                  <strong>All Data</strong>
                </span>
              </li>
              <li class="flex items-start gap-2">
                <span class="badge badge-primary flex-shrink-0 mt-0.5">4</span>
                <span
                  >Create export, download the ZIP file, then upload it
                  here</span
                >
              </li>
            </ol>
          </div>
        </section>

        <div
          id="status"
          class="alert alert-info hidden mb-4"
          role="status"
          aria-live="polite"
          aria-atomic="true"
        >
          <i
            data-lucide="loader-2"
            class="alert-icon icon spinner"
            aria-hidden="true"
          ></i>
          <div class="alert-content">Importing data, please wait…</div>
        </div>

        <form id="importForm" aria-label="Import weight data form">
          <div class="input-group mb-4">
            <label for="fileInput" class="label">
              <i
                data-lucide="archive"
                class="icon icon-sm inline-block mr-1.5"
                aria-hidden="true"
              ></i>
              Select ZIP File
            </label>
            <div class="file-input-wrapper">
              <input
                type="file"
                id="fileInput"
                name="fileInput"
                accept=".zip"
                aria-label="Select ZIP file from Google Takeout"
                aria-describedby="fileHelper fileError"
                aria-invalid="false"
                required
              />
              <label
                for="fileInput"
                class="file-input-label"
                id="fileInputLabel"
              >
                <i
                  data-lucide="upload"
                  class="icon icon-sm"
                  aria-hidden="true"
                ></i>
                <span class="file-input-filename">
                  <span class="file-input-placeholder"
                    >Click to select file</span
                  >
                </span>
                <i
                  data-lucide="archive"
                  class="icon icon-sm"
                  aria-hidden="true"
                ></i>
              </label>
            </div>
            <p id="fileHelper" class="helper-text">
              Select the ZIP file from your Google Takeout export
            </p>
            <div
              id="fileError"
              class="helper-text helper-text-error hidden"
              role="alert"
              aria-live="polite"
            ></div>
          </div>

          <button
            type="button"
            id="importBtn"
            class="btn btn-primary w-full"
            aria-label="Import weight data from selected file"
            aria-describedby="status"
          >
            <i
              data-lucide="upload"
              class="icon icon-sm"
              id="importIcon"
              aria-hidden="true"
            ></i>
            <span id="importText">Import Weight</span>
            <span
              id="spinner"
              class="spinner ml-2 hidden"
              aria-hidden="true"
              aria-label="Importing"
            ></span>
          </button>
        </form>
      </article>
    </main>

    <script>
      // Constants
      const WEIGHT_JSON_FILENAME =
        "derived_com.google.weight_com.google.android.g.json";
      const ERROR_DISPLAY_DURATION = 5000;
      const SUCCESS_CLOSE_DELAY = 2000;

      // DOM element references
      let fileInput;
      let fileInputLabel;
      let fileInputFilename;
      let importBtn;
      let importIcon;
      let importText;
      let spinner;
      let status;
      let statusContent;
      let fileError;

      /**
       * Updates the file input label to show selected file
       */
      const updateFileInputLabel = () => {
        if (!fileInput || !fileInputFilename || !fileInputLabel) {
          return;
        }

        const file = fileInput.files[0];
        const placeholder = fileInputFilename.querySelector(
          ".file-input-placeholder"
        );

        if (file) {
          // Remove placeholder if exists
          if (placeholder) {
            placeholder.remove();
          }

          // Validate it's a ZIP file
          const isZip =
            file.name.toLowerCase().endsWith(".zip") ||
            file.type === "application/zip" ||
            file.type === "application/x-zip-compressed";

          if (isZip) {
            fileInputFilename.textContent = file.name;
            fileInputLabel.classList.add("has-file");
            fileInputLabel.classList.remove("error");
            fileInput.setAttribute("aria-invalid", "false");
            if (fileError) {
              fileError.classList.add("hidden");
            }
          } else {
            fileInputFilename.textContent = file.name + " (not a ZIP file)";
            fileInputLabel.classList.remove("has-file");
            fileInputLabel.classList.add("error");
            fileInput.setAttribute("aria-invalid", "true");
          }
        } else {
          // Reset to placeholder
          fileInputFilename.innerHTML =
            '<span class="file-input-placeholder">Click to select file</span>';
          fileInputLabel.classList.remove("has-file", "error");
          fileInput.setAttribute("aria-invalid", "false");
        }

        // Re-initialize icons after DOM update
        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }
      };

      /**
       * Shows an error message
       * @param {string} message - Error message to display
       */
      const showError = (message) => {
        if (!fileError) {
          return;
        }

        fileError.textContent = message;
        fileError.classList.remove("hidden");
        fileInputLabel.classList.add("error");
        fileInputLabel.classList.remove("has-file");
        fileInput.setAttribute("aria-invalid", "true");

        // Clear error after duration
        setTimeout(() => {
          fileError.classList.add("hidden");
          fileInputLabel.classList.remove("error");
          fileInput.setAttribute("aria-invalid", "false");
          updateFileInputLabel();
        }, ERROR_DISPLAY_DURATION);
      };

      /**
       * Sets loading state
       */
      const setLoadingState = () => {
        fileInput.disabled = true;
        importBtn.disabled = true;
        importIcon.classList.add("hidden");
        importText.textContent = "Processing...";
        spinner.classList.remove("hidden");
        status.classList.remove("hidden");
        status.className = "alert alert-info mb-4";
        statusContent.textContent = "Processing file, please wait…";
      };

      /**
       * Resets UI to initial state
       */
      const resetUI = () => {
        fileInput.disabled = false;
        importBtn.disabled = false;
        importIcon.classList.remove("hidden");
        importText.textContent = "Import Weight";
        spinner.classList.add("hidden");
      };

      /**
       * Shows success message
       * @param {number} count - Number of entries imported
       */
      const showSuccess = (count) => {
        status.className = "alert alert-success mb-4";
        status.innerHTML = `
          <i data-lucide="check-circle-2" class="alert-icon icon" aria-hidden="true"></i>
          <div class="alert-content">Successfully imported ${count} weight entries!</div>
        `;

        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }

        // Close dialog after delay
        setTimeout(() => {
          if (
            typeof google !== "undefined" &&
            google.script &&
            google.script.host
          ) {
            google.script.host.close();
          }
        }, SUCCESS_CLOSE_DELAY);
      };

      /**
       * Shows error in status area
       * @param {string} message - Error message
       */
      const showStatusError = (message) => {
        status.className = "alert alert-error mb-4";
        status.innerHTML = `
          <i data-lucide="alert-circle" class="alert-icon icon" aria-hidden="true"></i>
          <div class="alert-content">${message}</div>
        `;
        status.classList.remove("hidden");

        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }

        resetUI();
      };

      /**
       * Recursively searches for a file in ZIP structure
       * @param {JSZip} zip - JSZip instance
       * @param {string} filename - Filename to search for
       * @returns {string|null} Full path to the file or null if not found
       */
      const findFileInZip = (zip, filename) => {
        for (const [path, file] of Object.entries(zip.files)) {
          const pathParts = path.split("/");
          const fileName = pathParts[pathParts.length - 1];
          if (fileName === filename) {
            return path;
          }
        }
        return null;
      };

      /**
       * Extracts and processes the weight JSON file from ZIP
       * @param {ArrayBuffer} zipData - ZIP file data as ArrayBuffer
       */
      const extractAndImportWeight = async (zipData) => {
        try {
          // Check if JSZip is available
          if (typeof JSZip === "undefined") {
            showStatusError(
              "ZIP library not loaded. Please refresh and try again."
            );
            return;
          }

          // Load ZIP file
          const zip = await JSZip.loadAsync(zipData);

          // Search for weight JSON file
          const weightJsonPath = findFileInZip(zip, WEIGHT_JSON_FILENAME);

          if (!weightJsonPath) {
            showStatusError(
              `Could not find ${WEIGHT_JSON_FILENAME} in the ZIP file. ` +
                "Please ensure you exported Google Fit data with 'All Data' selected."
            );
            return;
          }

          // Extract JSON content
          const weightJsonFile = zip.file(weightJsonPath);
          if (!weightJsonFile) {
            showStatusError(
              "Found weight JSON file but could not extract it. The file may be corrupted."
            );
            return;
          }

          const jsonContent = await weightJsonFile.async("string");

          // Verify it's valid JSON and has content
          if (!jsonContent || jsonContent.trim().length === 0) {
            showStatusError("The weight JSON file appears to be empty.");
            return;
          }

          // Check if Google Script is available
          if (
            typeof google === "undefined" ||
            !google.script ||
            !google.script.run
          ) {
            showStatusError("Unable to connect to Google Apps Script.");
            return;
          }

          // Import the JSON content
          google.script.run
            .withSuccessHandler(showSuccess)
            .withFailureHandler((err) => {
              const errorMessage =
                err && err.message
                  ? `Import failed: ${err.message}`
                  : "Import failed: Unknown error";
              showStatusError(errorMessage);
            })
            .importWeightFromTakeout(jsonContent);
        } catch (error) {
          console.error("ZIP extraction error:", error);
          if (error.message && error.message.includes("not a valid zip")) {
            showStatusError(
              "The selected file is not a valid ZIP archive. Please check the file and try again."
            );
          } else {
            showStatusError(
              `Failed to process ZIP file: ${error.message || "Unknown error"}`
            );
          }
        }
      };

      /**
       * Handles the import process
       */
      const doImport = () => {
        const file = fileInput.files[0];

        // Validate file selection
        if (!file) {
          showError("Please select the Takeout ZIP file.");
          return;
        }

        // Validate it's a ZIP file
        const isZip =
          file.name.toLowerCase().endsWith(".zip") ||
          file.type === "application/zip" ||
          file.type === "application/x-zip-compressed";

        if (!isZip) {
          showError(
            "Please select a ZIP file from your Google Takeout export."
          );
          return;
        }

        // Set loading state
        setLoadingState();
        statusContent.textContent = "Extracting ZIP file, please wait…";

        // Read ZIP file as ArrayBuffer
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            statusContent.textContent =
              "Searching for weight data, please wait…";
            await extractAndImportWeight(e.target.result);
          } catch (error) {
            console.error("Import error:", error);
            showStatusError(
              `Failed to process file: ${error.message || "Unknown error"}`
            );
          }
        };

        reader.onerror = () => {
          showStatusError("Failed to read ZIP file. Please try again.");
        };

        reader.readAsArrayBuffer(file);
      };

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        // Cache DOM references
        fileInput = document.getElementById("fileInput");
        fileInputLabel = document.getElementById("fileInputLabel");
        if (fileInputLabel) {
          fileInputFilename = fileInputLabel.querySelector(
            ".file-input-filename"
          );
        }
        importBtn = document.getElementById("importBtn");
        importIcon = document.getElementById("importIcon");
        importText = document.getElementById("importText");
        spinner = document.getElementById("spinner");
        status = document.getElementById("status");
        statusContent = status ? status.querySelector(".alert-content") : null;
        fileError = document.getElementById("fileError");

        // Set up event listeners
        if (fileInput) {
          fileInput.addEventListener("change", updateFileInputLabel);
        }

        if (importBtn) {
          importBtn.addEventListener("click", doImport);
        }

        // Initialize icons
        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }
      });
    </script>
  </body>
</html>
