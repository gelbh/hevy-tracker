<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hevy API Key Setup</title>
    <base target="_blank" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <?!= HtmlService.createHtmlOutputFromFile('ui/dialogs/shared-theme').getContent() ?>
  </head>
  <body
    class="bg-[hsl(var(--background))] text-[hsl(var(--foreground))] fade-in centered-content"
    role="dialog"
    aria-labelledby="dialog-title"
    aria-modal="true"
    style="width: 100%; padding: 1.25rem"
  >
    <main
      class="flex flex-col gap-4"
      style="width: 100%; max-width: 28rem; margin: 0 auto"
    >
      <header
        class="flex flex-col items-center gap-3 pb-4"
        style="border-bottom: 1px solid hsl(var(--border))"
      >
        <div
          class="p-5 bg-[hsl(var(--muted)/0.5)] rounded-[calc(var(--radius)+4px)] inline-flex items-center justify-center border-none"
          aria-hidden="true"
        >
          <img
            src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSoGEB844_CYQW6htIdn_4jDFuks7kmLBU-Rg&s"
            alt=""
            class="max-w-[100px] h-auto block"
            width="100"
            height="auto"
            style="border: none; outline: none"
          />
        </div>
        <h1 id="dialog-title" class="heading-4 m-0 text-center">
          Hevy API Key Setup
        </h1>
      </header>

      <section aria-labelledby="dialog-title">
        <p
          class="text-sm text-[hsl(var(--muted-foreground))] leading-relaxed mb-4"
        >
          Enter your Hevy API key. You can find it in your
          <a
            href="https://hevy.com/settings?developer"
            target="_blank"
            rel="noopener noreferrer"
            class="text-[hsl(var(--primary))] hover:underline font-medium"
            aria-label="Open Hevy Developer Settings in a new tab"
          >
            Hevy Developer Settings
          </a>
          .
        </p>

        <form id="apiKeyForm" novalidate aria-label="API key setup form">
          <div class="input-group">
            <label for="apiKey" class="label label-required"> API Key </label>
            <div class="relative">
              <i
                data-lucide="key"
                class="input-icon icon"
                aria-hidden="true"
              ></i>
              <input
                type="text"
                id="apiKey"
                name="apiKey"
                class="input input-with-icon"
                placeholder="Enter API key (UUID format)"
                aria-label="API Key"
                aria-required="true"
                aria-invalid="false"
                aria-describedby="helperText errorMessage"
                autocomplete="off"
                required
              />
            </div>
            <p id="helperText" class="helper-text">
              Format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
            </p>
          </div>

          <div
            id="errorMessage"
            class="alert alert-error hidden"
            role="alert"
            aria-live="polite"
            aria-atomic="true"
          >
            <i
              data-lucide="alert-circle"
              class="alert-icon icon"
              aria-hidden="true"
            ></i>
            <div class="alert-content"></div>
          </div>
        </form>
      </section>

      <nav class="flex justify-end gap-3 pt-1" aria-label="Dialog actions">
        <button
          type="button"
          id="cancelBtn"
          class="btn btn-secondary"
          aria-label="Cancel and close dialog"
        >
          <i data-lucide="x" class="icon icon-sm" aria-hidden="true"></i>
          Cancel
        </button>
        <button
          type="button"
          id="saveButton"
          class="btn btn-primary"
          disabled
          aria-label="Save API key"
          aria-describedby="errorMessage"
        >
          <i
            data-lucide="save"
            class="icon icon-sm"
            id="saveIcon"
            aria-hidden="true"
          ></i>
          <span id="saveText">Save</span>
          <span
            id="spinner"
            class="spinner ml-2 hidden"
            aria-hidden="true"
            aria-label="Saving"
          ></span>
        </button>
      </nav>
    </main>

    <script>
      // Application state
      let isSaving = false;
      let timeoutId = null;

      // DOM element references
      let apiKeyInput;
      let saveButton;
      let cancelBtn;
      let spinner;
      let saveIcon;
      let saveText;
      let errorMessage;
      let errorContent;

      /**
       * Extracts error message from various error formats
       * @param {string|Error|Object} error - The error object
       * @returns {string} Human-readable error message
       */
      const extractErrorMessage = (error) => {
        if (typeof error === "string") {
          return error;
        }
        if (error && error.message) {
          return error.message;
        }
        if (error && typeof error.toString === "function") {
          return error.toString();
        }
        return "An unknown error occurred. Please try again.";
      };

      /**
       * Validates input and updates UI state
       */
      const validateInput = () => {
        const apiKey = apiKeyInput.value.trim();
        const hasValue = apiKey.length > 0;

        saveButton.disabled = !hasValue || isSaving;

        // Visual feedback
        if (hasValue) {
          apiKeyInput.classList.remove("input-error");
          apiKeyInput.classList.add("input-success");
          apiKeyInput.setAttribute("aria-invalid", "false");
        } else {
          apiKeyInput.classList.remove("input-success", "input-error");
          apiKeyInput.setAttribute("aria-invalid", "false");
        }
      };

      /**
       * Resets UI to initial state
       */
      const resetUI = () => {
        isSaving = false;
        saveButton.disabled = false;
        apiKeyInput.disabled = false;
        spinner.classList.add("hidden");
        saveIcon.classList.remove("hidden");
        saveText.textContent = "Save";

        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
      };

      /**
       * Closes the dialog
       */
      const closeDialog = () => {
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
        if (
          typeof google !== "undefined" &&
          google.script &&
          google.script.host
        ) {
          google.script.host.close();
        }
      };

      /**
       * Displays error message in the UI
       * @param {string} message - Error message to display
       */
      const showError = (message) => {
        errorContent.textContent = message;
        errorMessage.classList.remove("hidden");
        apiKeyInput.classList.add("input-error");
        apiKeyInput.classList.remove("input-success");
        apiKeyInput.setAttribute("aria-invalid", "true");
      };

      /**
       * Hides error message
       */
      const hideError = () => {
        errorMessage.classList.add("hidden");
        errorContent.textContent = "";
      };

      /**
       * Saves the API key
       */
      const saveApiKey = () => {
        if (isSaving) {
          return;
        }

        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
          return;
        }

        // Use shared validation utility
        const validationError =
          window.HevyTrackerUtils &&
          window.HevyTrackerUtils.validateApiKeyFormat
            ? window.HevyTrackerUtils.validateApiKeyFormat(apiKey)
            : null;

        if (validationError) {
          showError(validationError);
          return;
        }

        // Set saving state
        isSaving = true;
        hideError();

        // Update UI to loading state
        saveButton.disabled = true;
        apiKeyInput.disabled = true;
        spinner.classList.remove("hidden");
        saveIcon.classList.add("hidden");
        saveText.textContent = "Saving...";

        // Set timeout for long-running requests (35 seconds)
        timeoutId = setTimeout(() => {
          if (isSaving) {
            showError(
              "Request is taking longer than expected. Please wait or try again."
            );
          }
        }, 35000);

        // Save API key via Google Apps Script
        if (
          typeof google !== "undefined" &&
          google.script &&
          google.script.run
        ) {
          google.script.run
            .withSuccessHandler((isNewKey) => {
              if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
              }
              isSaving = false;

              // Close dialog on success
              closeDialog();

              // Start initial import if this is a new key
              if (isNewKey && google.script.run) {
                google.script.run
                  .withSuccessHandler(() => {
                    // Import started successfully
                  })
                  .withFailureHandler((error) => {
                    console.error("Failed to start initial import:", error);
                  })
                  .runInitialImport();
              }
            })
            .withFailureHandler((error) => {
              resetUI();
              showError(extractErrorMessage(error));

              // Re-initialize icons after DOM update
              if (
                window.HevyTrackerUtils &&
                window.HevyTrackerUtils.initIcons
              ) {
                window.HevyTrackerUtils.initIcons();
              }
            })
            .saveUserApiKey(apiKey);
        }
      };

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        // Cache DOM references
        apiKeyInput = document.getElementById("apiKey");
        saveButton = document.getElementById("saveButton");
        cancelBtn = document.getElementById("cancelBtn");
        spinner = document.getElementById("spinner");
        saveIcon = document.getElementById("saveIcon");
        saveText = document.getElementById("saveText");
        errorMessage = document.getElementById("errorMessage");
        errorContent = errorMessage.querySelector(".alert-content");

        // Set up event listeners
        if (apiKeyInput) {
          apiKeyInput.addEventListener("input", validateInput);
        }

        if (saveButton) {
          saveButton.addEventListener("click", saveApiKey);
        }

        if (cancelBtn) {
          cancelBtn.addEventListener("click", closeDialog);
        }

        // Initialize icons
        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }
      });
    </script>
  </body>
</html>
