<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Developer API Key Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <?!= HtmlService.createHtmlOutputFromFile('ui/dialogs/shared-theme').getContent() ?>
  </head>
  <body
    class="bg-[hsl(var(--background))] text-[hsl(var(--foreground))] p-6 fade-in"
    role="dialog"
    aria-labelledby="dialog-title"
  >
    <main class="space-y-5">
      <header class="flex items-center gap-3 mb-6">
        <i
          data-lucide="key-round"
          class="icon icon-xl text-[hsl(var(--primary))]"
          aria-hidden="true"
        ></i>
        <h1 id="dialog-title" class="heading-2 m-0">
          Developer API Key Manager
        </h1>
      </header>

      <div
        id="notification"
        class="hidden fixed top-4 right-4 z-50 max-w-md"
        role="alert"
        aria-live="polite"
      ></div>

      <aside
        class="alert alert-info scale-in"
        role="note"
        aria-labelledby="info-heading"
        style="animation-delay: 25ms"
      >
        <i data-lucide="info" class="alert-icon icon" aria-hidden="true"></i>
        <div class="alert-content">
          <h2 id="info-heading" class="heading-4 mb-2 mt-0">
            Per-User Storage
          </h2>
          <p class="mb-0">
            API keys are stored per-user and are not shared across users. Each
            developer will only see and manage their own API keys.
          </p>
        </div>
      </aside>

      <section class="card scale-in" aria-labelledby="current-key-heading">
        <div class="card-content">
          <div class="flex items-center gap-2 mb-4">
            <i
              data-lucide="key"
              class="icon text-[hsl(var(--primary))]"
              aria-hidden="true"
            ></i>
            <h2 id="current-key-heading" class="label m-0">Current API Key</h2>
          </div>
          <div class="flex items-center gap-3">
            <div
              id="currentKey"
              role="status"
              aria-live="polite"
              aria-atomic="true"
              class="flex-1 m-0 p-3 bg-[hsl(var(--muted))] rounded-md font-mono text-sm"
            >
              Loading...
            </div>
            <button
              type="button"
              class="btn btn-ghost hidden"
              id="toggleKeyBtn"
              aria-label="Toggle API key visibility"
              aria-expanded="false"
            >
              <i
                data-lucide="eye"
                class="icon icon-sm"
                id="toggleIcon"
                aria-hidden="true"
              ></i>
              <span id="toggleText">Show</span>
            </button>
          </div>
        </div>
      </section>

      <section
        class="card scale-in"
        style="animation-delay: 50ms"
        aria-labelledby="switch-key-heading"
      >
        <div class="card-content">
          <div class="flex items-center gap-2 mb-4">
            <i
              data-lucide="switch-camera"
              class="icon text-[hsl(var(--primary))]"
              aria-hidden="true"
            ></i>
            <h2 id="switch-key-heading" class="label m-0">Switch to API Key</h2>
          </div>
          <div class="flex items-center gap-3">
            <label for="switchLabel" class="sr-only"
              >Select API key to switch to</label
            >
            <select
              id="switchLabel"
              class="input flex-1"
              aria-label="Select API key to switch to"
            >
              <option value="">Select a key...</option>
            </select>
            <button
              type="button"
              id="switchBtn"
              class="btn btn-primary"
              aria-label="Switch to selected API key"
            >
              <i
                data-lucide="refresh-cw"
                class="icon icon-sm"
                id="switchBtnIcon"
                aria-hidden="true"
              ></i>
              <span id="switchBtnText">Switch</span>
            </button>
          </div>
        </div>
      </section>

      <section
        class="card scale-in"
        style="animation-delay: 100ms"
        aria-labelledby="new-key-heading"
      >
        <div class="card-content">
          <div class="flex items-center gap-2 mb-4">
            <i
              data-lucide="plus-circle"
              class="icon text-[hsl(var(--primary))]"
              aria-hidden="true"
            ></i>
            <h2 id="new-key-heading" class="label m-0">
              New Label and API Key
            </h2>
          </div>
          <form id="addKeyForm" aria-label="Add new API key form">
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div class="input-group flex-1">
                  <label for="label" class="label text-xs mb-1">Label</label>
                  <input
                    type="text"
                    id="label"
                    name="label"
                    class="input"
                    placeholder="e.g. main, dev"
                    aria-label="Label for the API key"
                    required
                  />
                </div>
                <div class="input-group flex-[2]">
                  <label for="key" class="label text-xs mb-1">API Key</label>
                  <div class="relative">
                    <i
                      data-lucide="key"
                      class="input-icon icon"
                      aria-hidden="true"
                    ></i>
                    <input
                      type="text"
                      id="key"
                      name="key"
                      class="input input-with-icon"
                      placeholder="Paste API key here"
                      aria-label="API key"
                      aria-describedby="keyError"
                      required
                    />
                  </div>
                  <div
                    id="keyError"
                    class="helper-text helper-text-error hidden"
                    role="alert"
                    aria-live="polite"
                  ></div>
                </div>
                <div class="flex items-end">
                  <button
                    type="button"
                    id="saveBtn"
                    class="btn btn-primary"
                    aria-label="Save new API key with label"
                  >
                    <i
                      data-lucide="save"
                      class="icon icon-sm"
                      id="saveBtnIcon"
                      aria-hidden="true"
                    ></i>
                    <span id="saveBtnText">Save</span>
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </section>

      <section
        class="card scale-in"
        style="animation-delay: 150ms"
        aria-labelledby="remove-key-heading"
      >
        <div class="card-content">
          <div class="flex items-center gap-2 mb-4">
            <i
              data-lucide="trash-2"
              class="icon text-[hsl(var(--destructive))]"
              aria-hidden="true"
            ></i>
            <h2 id="remove-key-heading" class="label m-0">Remove API Key</h2>
          </div>
          <div class="flex items-center gap-3">
            <label for="removeLabel" class="sr-only"
              >Select API key to remove</label
            >
            <select
              id="removeLabel"
              class="input flex-1"
              aria-label="Select API key to remove"
            >
              <option value="">Select a key to remove...</option>
            </select>
            <button
              type="button"
              id="removeBtn"
              class="btn btn-destructive"
              aria-label="Remove selected API key"
            >
              <i
                data-lucide="trash-2"
                class="icon icon-sm"
                id="removeBtnIcon"
                aria-hidden="true"
              ></i>
              <span id="removeBtnText">Remove</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <script>
      // Application state
      let fullApiKey = null;
      let currentKeyLabel = null;
      let isKeyVisible = false;

      // DOM element references
      let currentDisplay;
      let toggleBtn;
      let toggleIcon;
      let toggleText;
      let switchDropdown;
      let removeDropdown;
      let labelInput;
      let keyInput;
      let keyError;
      let switchBtn;
      let removeBtn;
      let saveBtn;
      let notification;
      let switchBtnIcon;
      let switchBtnText;
      let saveBtnIcon;
      let saveBtnText;
      let removeBtnIcon;
      let removeBtnText;

      // Loading state tracking
      let isLoading = false;

      /**
       * Masks API key showing only last 4 characters
       * @param {string} key - API key to mask
       * @returns {string} Masked API key
       */
      const maskApiKey = (key) => {
        if (!key || key.length < 4) {
          return "Not set";
        }
        const lastFour = key.slice(-4);
        return `****-****-****-${lastFour}`;
      };

      /**
       * Updates key visibility toggle state
       */
      const updateKeyDisplay = () => {
        if (!fullApiKey || !currentDisplay) {
          return;
        }

        const labelText = currentKeyLabel ? `Label: ${currentKeyLabel}, ` : "";
        const keyText = isKeyVisible ? fullApiKey : maskApiKey(fullApiKey);

        currentDisplay.textContent = `${labelText}Key: ${keyText}`;

        if (toggleBtn && toggleIcon && toggleText) {
          if (isKeyVisible) {
            toggleIcon.setAttribute("data-lucide", "eye-off");
            toggleText.textContent = "Hide";
            toggleBtn.setAttribute("aria-label", "Hide API key");
            toggleBtn.setAttribute("aria-expanded", "true");
          } else {
            toggleIcon.setAttribute("data-lucide", "eye");
            toggleText.textContent = "Show";
            toggleBtn.setAttribute("aria-label", "Show API key");
            toggleBtn.setAttribute("aria-expanded", "false");
          }
        }

        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }
      };

      /**
       * Toggles key visibility
       */
      const toggleKeyVisibility = () => {
        if (!fullApiKey) {
          return;
        }
        isKeyVisible = !isKeyVisible;
        updateKeyDisplay();
      };

      /**
       * Shows error message for key input
       * @param {string} message - Error message
       */
      const showKeyError = (message) => {
        if (keyError) {
          keyError.textContent = message;
          keyError.classList.remove("hidden");
        }
        if (keyInput) {
          keyInput.classList.add("input-error");
        }
      };

      /**
       * Hides error message for key input
       */
      const hideKeyError = () => {
        if (keyError) {
          keyError.classList.add("hidden");
          keyError.textContent = "";
        }
        if (keyInput) {
          keyInput.classList.remove("input-error");
        }
      };

      /**
       * Shows a notification message
       * @param {string} message - Message to display
       * @param {string} type - Type: 'success' or 'error'
       */
      const showNotification = (message, type = "success") => {
        if (!notification) return;

        const isSuccess = type === "success";
        const bgColor = isSuccess
          ? "bg-[hsl(var(--success))]"
          : "bg-[hsl(var(--destructive))]";
        const icon = isSuccess ? "check-circle-2" : "alert-circle";
        const iconColor = isSuccess ? "text-white" : "text-white";

        notification.className = `${bgColor} text-white p-4 rounded-lg shadow-lg flex items-center gap-3`;
        notification.innerHTML = `
          <i data-lucide="${icon}" class="icon ${iconColor}" aria-hidden="true"></i>
          <span>${message}</span>
        `;
        notification.classList.remove("hidden");

        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }

        // Auto-hide after 3 seconds
        setTimeout(() => {
          if (notification) {
            notification.classList.add("hidden");
          }
        }, 3000);
      };

      /**
       * Sets loading state on a button
       * @param {HTMLElement} button - Button element
       * @param {HTMLElement} icon - Icon element
       * @param {HTMLElement} text - Text span element
       * @param {boolean} loading - Whether to show loading state
       */
      const setButtonLoading = (button, icon, text, loading) => {
        if (!button || !icon || !text) return;

        if (loading) {
          button.disabled = true;
          button.classList.add("opacity-50", "cursor-not-allowed");
          icon.setAttribute("data-lucide", "loader-2");
          icon.classList.add("animate-spin");
          if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
            window.HevyTrackerUtils.initIcons();
          }
        } else {
          button.disabled = false;
          button.classList.remove("opacity-50", "cursor-not-allowed");
          icon.classList.remove("animate-spin");
        }
      };

      /**
       * Populates UI with API key data
       * @param {Array} keys - Array of key objects with label and key
       * @param {string} currentKey - Current API key value
       */
      const populateUI = (keys, currentKey) => {
        // Populate dropdowns
        switchDropdown.innerHTML = '<option value="">Select a key...</option>';
        removeDropdown.innerHTML =
          '<option value="">Select a key to remove...</option>';

        keys.forEach(({ label }) => {
          switchDropdown.add(new Option(label, label));
          removeDropdown.add(new Option(label, label));
        });

        // Find matching key
        const match = keys.find((k) => k.key === currentKey);

        if (match) {
          currentKeyLabel = match.label;
          fullApiKey = match.key;
          isKeyVisible = false;
          if (toggleBtn) {
            toggleBtn.classList.remove("hidden");
          }
        } else if (currentKey) {
          currentKeyLabel = null;
          fullApiKey = currentKey;
          isKeyVisible = false;
          if (toggleBtn) {
            toggleBtn.classList.remove("hidden");
          }
        } else {
          currentKeyLabel = null;
          fullApiKey = null;
          isKeyVisible = false;
          if (toggleBtn) {
            toggleBtn.classList.add("hidden");
          }
        }

        updateKeyDisplay();

        // Re-initialize icons
        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }
      };

      /**
       * Refreshes UI from server data
       */
      const refreshUI = () => {
        if (
          typeof google === "undefined" ||
          !google.script ||
          !google.script.run
        ) {
          return;
        }

        google.script.run
          .withSuccessHandler(({ keys, current }) => {
            populateUI(keys, current);
          })
          .withFailureHandler((error) => {
            console.error("Failed to load API key data:", error);
            if (currentDisplay) {
              currentDisplay.textContent = "Error loading data";
            }
          })
          .getApiKeyDataForUI();
      };

      /**
       * Saves new API key
       */
      const saveKey = () => {
        if (isLoading) return;

        const label = labelInput ? labelInput.value.trim() : "";
        const key = keyInput ? keyInput.value.trim() : "";

        hideKeyError();

        if (!label || !key) {
          showKeyError("Both label and key are required.");
          return;
        }

        // Use shared validation utility
        const validationError =
          window.HevyTrackerUtils &&
          window.HevyTrackerUtils.validateApiKeyFormat
            ? window.HevyTrackerUtils.validateApiKeyFormat(key)
            : null;

        if (validationError) {
          showKeyError(validationError);
          return;
        }

        if (
          typeof google === "undefined" ||
          !google.script ||
          !google.script.run
        ) {
          showKeyError("Unable to connect to Google Apps Script.");
          return;
        }

        isLoading = true;
        setButtonLoading(saveBtn, saveBtnIcon, saveBtnText, true);

        google.script.run
          .withSuccessHandler(() => {
            isLoading = false;
            setButtonLoading(saveBtn, saveBtnIcon, saveBtnText, false);
            refreshUI();
            if (labelInput) labelInput.value = "";
            if (keyInput) keyInput.value = "";
            hideKeyError();
            showNotification(
              `API key "${label}" saved successfully!`,
              "success"
            );
          })
          .withFailureHandler((error) => {
            isLoading = false;
            setButtonLoading(saveBtn, saveBtnIcon, saveBtnText, false);
            const errorMessage =
              error && error.message
                ? `Failed to save API key: ${error.message}`
                : "Failed to save API key: Unknown error";
            showKeyError(errorMessage);
            showNotification(errorMessage, "error");
          })
          .saveDevApiKey(label, key);
      };

      /**
       * Switches to selected API key
       */
      const switchKey = () => {
        if (isLoading) return;

        const label = switchDropdown ? switchDropdown.value : "";
        if (!label) {
          return;
        }

        if (
          typeof google === "undefined" ||
          !google.script ||
          !google.script.run
        ) {
          return;
        }

        isLoading = true;
        setButtonLoading(switchBtn, switchBtnIcon, switchBtnText, true);
        if (switchDropdown) switchDropdown.disabled = true;

        google.script.run
          .withSuccessHandler(() => {
            isLoading = false;
            setButtonLoading(switchBtn, switchBtnIcon, switchBtnText, false);
            if (switchDropdown) switchDropdown.disabled = false;
            refreshUI();
            showNotification(
              `Switched to API key "${label}". Data import started...`,
              "success"
            );
          })
          .withFailureHandler((error) => {
            isLoading = false;
            setButtonLoading(switchBtn, switchBtnIcon, switchBtnText, false);
            if (switchDropdown) switchDropdown.disabled = false;
            console.error("Failed to switch API key:", error);
            const errorMessage =
              error && error.message
                ? `Failed to switch API key: ${error.message}`
                : "Failed to switch API key: Unknown error";
            showNotification(errorMessage, "error");
          })
          .useApiKey(label);
      };

      /**
       * Removes selected API key
       */
      const removeKey = () => {
        if (isLoading) return;

        const label = removeDropdown ? removeDropdown.value : "";
        if (!label) {
          showNotification("Please select a key to remove.", "error");
          return;
        }

        if (
          !confirm(`Are you sure you want to remove the API key "${label}"?`)
        ) {
          return;
        }

        if (
          typeof google === "undefined" ||
          !google.script ||
          !google.script.run
        ) {
          showNotification("Unable to connect to Google Apps Script.", "error");
          return;
        }

        isLoading = true;
        setButtonLoading(removeBtn, removeBtnIcon, removeBtnText, true);
        if (removeDropdown) removeDropdown.disabled = true;

        google.script.run
          .withSuccessHandler(() => {
            isLoading = false;
            setButtonLoading(removeBtn, removeBtnIcon, removeBtnText, false);
            if (removeDropdown) removeDropdown.disabled = false;
            refreshUI();
            showNotification(
              `API key "${label}" removed successfully.`,
              "success"
            );
          })
          .withFailureHandler((error) => {
            isLoading = false;
            setButtonLoading(removeBtn, removeBtnIcon, removeBtnText, false);
            if (removeDropdown) removeDropdown.disabled = false;
            console.error("Failed to remove API key:", error);
            const errorMessage =
              error && error.message
                ? `Failed to remove API key: ${error.message}`
                : "Failed to remove API key: Unknown error";
            showNotification(errorMessage, "error");
          })
          .removeApiKey(label);
      };

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        // Cache DOM references
        currentDisplay = document.getElementById("currentKey");
        toggleBtn = document.getElementById("toggleKeyBtn");
        toggleIcon = document.getElementById("toggleIcon");
        toggleText = document.getElementById("toggleText");
        switchDropdown = document.getElementById("switchLabel");
        removeDropdown = document.getElementById("removeLabel");
        labelInput = document.getElementById("label");
        keyInput = document.getElementById("key");
        keyError = document.getElementById("keyError");
        switchBtn = document.getElementById("switchBtn");
        removeBtn = document.getElementById("removeBtn");
        saveBtn = document.getElementById("saveBtn");
        notification = document.getElementById("notification");
        switchBtnIcon = document.getElementById("switchBtnIcon");
        switchBtnText = document.getElementById("switchBtnText");
        saveBtnIcon = document.getElementById("saveBtnIcon");
        saveBtnText = document.getElementById("saveBtnText");
        removeBtnIcon = document.getElementById("removeBtnIcon");
        removeBtnText = document.getElementById("removeBtnText");

        // Set up event listeners
        if (toggleBtn) {
          toggleBtn.addEventListener("click", toggleKeyVisibility);
        }

        if (switchBtn) {
          switchBtn.addEventListener("click", switchKey);
        }

        if (removeBtn) {
          removeBtn.addEventListener("click", removeKey);
        }

        if (saveBtn) {
          saveBtn.addEventListener("click", saveKey);
        }

        if (keyInput) {
          keyInput.addEventListener("input", hideKeyError);
        }

        // Initialize icons
        if (window.HevyTrackerUtils && window.HevyTrackerUtils.initIcons) {
          window.HevyTrackerUtils.initIcons();
        }

        // Load initial data
        refreshUI();
      });
    </script>
  </body>
</html>
